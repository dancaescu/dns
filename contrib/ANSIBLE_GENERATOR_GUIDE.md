# MyDNS Ansible Generator Guide

**Copyright (C) 2025 Dan Caescu <dan.caescu@multitel.net>**

This guide explains the Ansible recipe generator that automatically creates deployment playbooks from the MyDNS contrib/ directory.

---

## Table of Contents

1. [Overview](#overview)
2. [Why Auto-Generate?](#why-auto-generate)
3. [How It Works](#how-it-works)
4. [Usage](#usage)
5. [Generated Files](#generated-files)
6. [Customization](#customization)
7. [Extending the Generator](#extending-the-generator)
8. [Troubleshooting](#troubleshooting)

---

## Overview

The Ansible generator (`generate_ansible.py`) is a Python script that scans the `contrib/` directory and automatically generates comprehensive Ansible playbooks for deploying MyDNS infrastructure.

**Key Benefits:**
- **No Manual Maintenance** - Playbooks are regenerated from source
- **Always in Sync** - Reflects current contrib/ directory structure
- **Consistent Deployment** - Same approach across all components
- **Easy Extension** - Add new features, regenerate playbooks
- **Version Control Friendly** - Generated files clearly marked

**Location:** `/scripts/mydns-ng-master/contrib/generate_ansible.py`

---

## Why Auto-Generate?

### The Problem

Traditional Ansible deployments require manually maintaining playbooks separately from the source code. This leads to:

1. **Drift** - Playbooks become outdated as code evolves
2. **Duplication** - Same information in multiple places (scripts, configs, playbooks)
3. **Maintenance Burden** - Every new feature requires updating playbooks
4. **Inconsistency** - Different playbooks use different patterns
5. **Documentation Mismatch** - Playbooks don't reflect actual deployment scripts

### The Solution

Auto-generate playbooks from the source directory:

```
contrib/
├── tsig-schema.sql          ────┐
├── dnsupdate-schema.sql         │
├── doh-schema.sql               ├──> Scan
├── sync_cloudflare_records.py   │
├── check_mydns.py               │
└── generate_ansible.py      ────┘
                                  │
                                  ▼
                          Generate Playbooks
                                  │
                                  ▼
ansible/
├── mydns-server.yml         (Auto-generated)
├── webui.yml                (Auto-generated)
├── database-schemas.yml     (Auto-generated)
├── cloudflare-sync.yml      (Auto-generated)
└── README.md                (Auto-generated)
```

**Benefits:**
- One source of truth (contrib/ directory)
- Playbooks always reflect current code
- New SQL schemas automatically included
- Consistent deployment patterns
- Documentation auto-updated

---

## How It Works

### Architecture

```python
generate_ansible.py
├── AnsibleGenerator class
│   ├── scan_directory()         # Discover files
│   ├── generate_mydns_server()  # MyDNS daemon playbook
│   ├── generate_webui()         # Web UI playbook
│   ├── generate_sensor()        # GeoIP sensor playbook
│   ├── generate_cloudflare()    # Cloudflare sync playbook
│   ├── generate_schemas()       # Database schemas playbook
│   ├── generate_inventory()     # Inventory template
│   └── generate_readme()        # Documentation
└── main()
```

### Discovery Process

1. **Scan contrib/ directory**
   ```python
   sql_schemas = glob.glob("contrib/*-schema.sql")
   python_scripts = glob.glob("contrib/*.py")
   config_files = glob.glob("contrib/*.ini")
   ```

2. **Categorize by type**
   - SQL schemas → `database-schemas.yml`
   - Python scripts → Various playbooks based on purpose
   - Config files → Configuration management tasks
   - Shell scripts → Execution tasks

3. **Generate playbooks**
   - Create Jinja2-like Ansible YAML
   - Add appropriate tasks for each file type
   - Include tags for selective execution
   - Add documentation headers

4. **Write output files**
   - `ansible/*.yml` - Playbooks
   - `ansible/inventory.example` - Inventory template
   - `ansible/README.md` - Documentation

### Template Structure

Each playbook follows this structure:

```yaml
---
# Auto-generated by generate_ansible.py on YYYY-MM-DD HH:MM:SS
# DO NOT MANUALLY EDIT - Regenerate using: python3 ../generate_ansible.py

- name: Playbook Name
  hosts: target_hosts
  become: true
  vars:
    # Variables
  tasks:
    - name: Task description
      module:
        parameter: value
      tags:
        - tag1
        - tag2
```

---

## Usage

### Basic Usage

```bash
cd /scripts/mydns-ng-master/contrib
python3 generate_ansible.py
```

**Output:**
```
Generated: ansible/mydns-server.yml (156 lines)
Generated: ansible/webui.yml (98 lines)
Generated: ansible/sensor.yml (54 lines)
Generated: ansible/cloudflare-sync.yml (42 lines)
Generated: ansible/database-schemas.yml (106 lines)
Generated: ansible/inventory.example (35 lines)
Generated: ansible/README.md (141 lines)

Ansible playbooks successfully generated in: /scripts/mydns-ng-master/contrib/ansible
```

### After Adding New Features

**Scenario:** You added a new SQL schema `contrib/new-feature-schema.sql`

```bash
# 1. Add the schema file
vim contrib/new-feature-schema.sql

# 2. Regenerate playbooks
cd contrib
python3 generate_ansible.py

# 3. The new schema is now automatically included in database-schemas.yml
```

### Deploying Generated Playbooks

```bash
cd /scripts/mydns-ng-master/contrib/ansible

# Create inventory
cp inventory.example inventory
vim inventory  # Edit with your servers

# Deploy MyDNS server
ansible-playbook -i inventory mydns-server.yml

# Apply all database schemas (including new ones!)
ansible-playbook -i inventory database-schemas.yml

# Deploy with specific tags
ansible-playbook -i inventory database-schemas.yml --tags tsig-schema

# Dry run
ansible-playbook -i inventory mydns-server.yml --check
```

---

## Generated Files

### 1. `ansible/mydns-server.yml`

**Purpose:** Deploy complete MyDNS server with all features

**Tasks:**
- Install dependencies (build-essential, libmysqlclient-dev, libssl-dev, etc.)
- Clone MyDNS repository
- Bootstrap build system
- Configure with all features enabled
- Build and install (make && make install)
- Create /etc/mydns/ directory
- Copy configuration files
- Install systemd unit
- Enable and start service

**Tags:**
- `dependencies` - Install packages only
- `source` - Download source code
- `build` - Compile MyDNS
- `config` - Configure MyDNS
- `service` - Manage service

**Usage:**
```bash
ansible-playbook -i inventory mydns-server.yml
```

---

### 2. `ansible/webui.yml`

**Purpose:** Deploy DNS Manager web interface

**Tasks:**
- Install Node.js, npm, nginx
- Clone/copy dnsmanager code
- Install npm dependencies (backend + frontend)
- Build frontend (npm run build)
- Configure environment (.env files)
- Setup PM2 for backend
- Configure nginx reverse proxy
- Setup TLS certificates (Let's Encrypt integration)

**Tags:**
- `dependencies` - Install Node.js, npm, nginx
- `backend` - Deploy backend API
- `frontend` - Deploy React frontend
- `nginx` - Configure reverse proxy
- `ssl` - Setup TLS certificates

**Usage:**
```bash
ansible-playbook -i inventory webui.yml
```

---

### 3. `ansible/database-schemas.yml`

**Purpose:** Apply all SQL schemas from contrib/

**Tasks:**
For each `*-schema.sql` file:
- Check if MySQL is installed
- Apply schema to database
- Report success/failure

**Schemas included (auto-discovered):**
- `tsig-schema.sql`
- `dnsupdate-schema.sql`
- `axfr-ixfr-schema.sql`
- `dnssec-schema.sql`
- `doh-schema.sql`
- `dns-cache-schema.sql`
- `user-cloudflare-acl-schema.sql`
- `axfr-slave-schema.sql`
- `soa-serial-trigger.sql`

**Tags:**
Each schema has its own tag (e.g., `tsig-schema`, `doh-schema`)

**Usage:**
```bash
# Apply all schemas
ansible-playbook -i inventory database-schemas.yml

# Apply specific schema
ansible-playbook -i inventory database-schemas.yml --tags tsig-schema

# Apply multiple schemas
ansible-playbook -i inventory database-schemas.yml --tags "tsig-schema,doh-schema"
```

---

### 4. `ansible/cloudflare-sync.yml`

**Purpose:** Setup Cloudflare zone synchronization

**Tasks:**
- Install Python dependencies (requests, pycryptodome, pymysql)
- Copy sync script (`sync_cloudflare_records_multi_user.py`)
- Configure /etc/mydns/cloudflare.ini
- Setup cron job (every 5 minutes)
- Create log directory
- Test initial sync

**Tags:**
- `dependencies` - Install Python packages
- `script` - Deploy sync script
- `config` - Configure credentials
- `cron` - Setup scheduled sync

**Usage:**
```bash
ansible-playbook -i inventory cloudflare-sync.yml
```

---

### 5. `ansible/sensor.yml`

**Purpose:** Deploy GeoIP sensors for distributed load balancing

**Tasks:**
- Install GeoIP libraries and databases
- Configure sensor reporting
- Setup monitoring
- Register with master server

**Tags:**
- `geoip` - Install GeoIP components
- `config` - Configure sensor
- `monitoring` - Setup monitoring

**Usage:**
```bash
ansible-playbook -i inventory sensor.yml
```

---

### 6. `ansible/inventory.example`

**Purpose:** Template for Ansible inventory

**Content:**
```ini
[mydns_servers]
dns1.example.com ansible_host=192.168.1.10 ansible_user=root
dns2.example.com ansible_host=192.168.1.11 ansible_user=root

[webui_servers]
webui.example.com ansible_host=192.168.1.20 ansible_user=root

[sensors]
sensor1.example.com ansible_host=192.168.1.30 ansible_user=root

[all:vars]
ansible_python_interpreter=/usr/bin/python3
mysql_host=192.168.1.100
mysql_user=root
mysql_password=changeme
mysql_database=did
```

**Usage:**
```bash
cp inventory.example inventory
vim inventory  # Edit with your servers
```

---

### 7. `ansible/README.md`

**Purpose:** Documentation for using generated playbooks

**Sections:**
- Quick start
- Available playbooks
- Tag usage
- Variable overrides
- Requirements
- Regeneration instructions

---

## Customization

### Modifying the Generator

**File:** `/scripts/mydns-ng-master/contrib/generate_ansible.py`

#### Example: Add New Playbook

```python
def generate_monitoring_playbook(self):
    """Generate playbook for monitoring setup"""
    playbook = f"""---
# Auto-generated on {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

- name: Setup MyDNS Monitoring
  hosts: mydns_servers
  become: true
  tasks:
    - name: Install monitoring tools
      apt:
        name:
          - nagios-plugins
          - monit
        state: present
      tags:
        - monitoring
        - dependencies

    - name: Copy check script
      copy:
        src: ../check_mydns.py
        dest: /usr/lib/nagios/plugins/check_mydns.py
        mode: '0755'
      tags:
        - monitoring
        - scripts
"""

    output_file = self.ansible_dir / "monitoring.yml"
    with open(output_file, 'w') as f:
        f.write(playbook)

    print(f"Generated: {output_file}")

# Add to generate_all() method
def generate_all(self):
    self.generate_mydns_server_playbook()
    self.generate_webui_playbook()
    self.generate_monitoring_playbook()  # NEW
    # ... rest of playbooks
```

Then regenerate:
```bash
python3 generate_ansible.py
```

#### Example: Customize Task Generation

```python
def generate_schema_task(self, schema_file):
    """Generate task for applying SQL schema"""
    schema_name = Path(schema_file).stem

    return f"""
  - name: Apply {schema_name} schema
    mysql_db:
      name: '{{{{ mysql_database }}}}'
      state: import
      target: {schema_file}
      login_user: '{{{{ mysql_user }}}}'
      login_password: '{{{{ mysql_password }}}}'
    tags:
      - schema
      - {schema_name}
    register: {schema_name}_result

  - name: Report {schema_name} status
    debug:
      msg: "Schema {schema_name} applied successfully"
    when: {schema_name}_result is succeeded
"""
```

---

## Extending the Generator

### Adding New File Types

**Scenario:** You want to automatically include shell scripts in deployments

```python
class AnsibleGenerator:
    def __init__(self, contrib_dir: str, output_dir: str):
        self.contrib_dir = Path(contrib_dir)
        self.output_dir = Path(output_dir)
        self.ansible_dir = self.output_dir / "ansible"

        # Scan for files
        self.sql_schemas = list(self.contrib_dir.glob("*-schema.sql"))
        self.python_scripts = list(self.contrib_dir.glob("*.py"))
        self.shell_scripts = list(self.contrib_dir.glob("*.sh"))  # NEW
        self.config_files = list(self.contrib_dir.glob("*.ini"))

    def generate_scripts_playbook(self):
        """Generate playbook for deploying shell scripts"""
        playbook = f"""---
# Auto-generated on {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

- name: Deploy MyDNS Scripts
  hosts: mydns_servers
  become: true
  tasks:
"""
        for script in self.shell_scripts:
            playbook += f"""
  - name: Deploy {script.name}
    copy:
      src: ../{script.name}
      dest: /usr/local/bin/{script.stem}
      mode: '0755'
    tags:
      - scripts
      - {script.stem}
"""

        output_file = self.ansible_dir / "scripts.yml"
        with open(output_file, 'w') as f:
            f.write(playbook)

        print(f"Generated: {output_file}")

    def generate_all(self):
        # ... existing playbooks
        self.generate_scripts_playbook()  # NEW
```

### Adding Variables

```python
def generate_webui_playbook(self):
    playbook = f"""---
- name: Deploy MyDNS Web UI
  hosts: webui_servers
  become: true
  vars:
    # NEW: Configurable variables
    nodejs_version: "18.x"
    webui_domain: "{{{{ webui_domain | default('dns.example.com') }}}}"
    webui_port: "{{{{ webui_port | default(4000) }}}}"
    frontend_port: "{{{{ frontend_port | default(5173) }}}}"
  tasks:
    # ... tasks using these variables
"""
```

---

## Troubleshooting

### Generator Fails to Run

**Error:** `ModuleNotFoundError: No module named 'yaml'`

**Solution:**
```bash
pip3 install pyyaml
```

---

**Error:** `FileNotFoundError: [Errno 2] No such file or directory: 'ansible'`

**Solution:**
```bash
mkdir -p /scripts/mydns-ng-master/contrib/ansible
```

---

### Generated Playbooks Fail

**Error:** `ERROR! couldn't resolve module/action 'mysql_db'`

**Solution:**
```bash
# Install Ansible MySQL modules
ansible-galaxy collection install community.mysql
```

---

**Error:** `Permission denied` when applying schemas

**Solution:**
Check MySQL credentials in inventory:
```ini
[all:vars]
mysql_user=root
mysql_password=correct_password  # Fix this
mysql_database=did
```

---

### Schemas Not Included

**Problem:** New schema file not showing up in generated playbook

**Checklist:**
1. Is file named `*-schema.sql`?
2. Is file in `contrib/` directory?
3. Did you regenerate playbooks?

**Solution:**
```bash
# Check filename
ls -l contrib/*-schema.sql

# Regenerate
cd contrib
python3 generate_ansible.py

# Verify inclusion
grep "new-feature-schema" ansible/database-schemas.yml
```

---

## Best Practices

### 1. Always Regenerate After Changes

```bash
# After adding/modifying files in contrib/
cd /scripts/mydns-ng-master/contrib
python3 generate_ansible.py
git add ansible/
git commit -m "Regenerate Ansible playbooks"
```

### 2. Don't Manually Edit Generated Files

Generated playbooks include this warning:
```yaml
# DO NOT MANUALLY EDIT - Regenerate using: python3 ../generate_ansible.py
```

If you need customization, edit the generator instead.

### 3. Version Control

```bash
# .gitignore - DON'T ignore generated files
# They should be committed to show what gets deployed

git add contrib/ansible/
git commit -m "Update Ansible playbooks"
```

### 4. Test Before Deploying

```bash
# Dry run
ansible-playbook -i inventory mydns-server.yml --check

# Limit to one host
ansible-playbook -i inventory mydns-server.yml --limit dns1.example.com

# Run specific tags
ansible-playbook -i inventory mydns-server.yml --tags dependencies
```

### 5. Keep Generator Simple

Don't overcomplicate the generator. It should:
- Scan directory structure
- Generate consistent playbooks
- Be easy to understand and modify

Avoid:
- Complex logic
- Too many customization options
- Tight coupling to specific infrastructure

---

## Advanced Usage

### Dynamic Inventory

Instead of static inventory, use dynamic inventory from cloud providers:

```bash
# AWS
ansible-playbook -i aws_ec2.yml mydns-server.yml

# GCP
ansible-playbook -i gcp_compute.yml mydns-server.yml
```

### Ansible Vault for Secrets

```bash
# Encrypt sensitive variables
ansible-vault create group_vars/all/vault.yml

# Content:
vault_mysql_password: SecurePassword123!
vault_cf_api_key: cloudflare-api-key-here

# Use in playbooks:
mysql_password: "{{ vault_mysql_password }}"

# Run with vault password
ansible-playbook -i inventory mydns-server.yml --ask-vault-pass
```

### CI/CD Integration

```yaml
# .gitlab-ci.yml
deploy_mydns:
  stage: deploy
  script:
    - cd contrib
    - python3 generate_ansible.py
    - cd ansible
    - ansible-playbook -i inventory mydns-server.yml
  only:
    - main
```

---

## Summary

The Ansible generator provides:

- **Automated playbook generation** from source directory
- **Always in sync** with current codebase
- **Consistent deployment patterns** across all components
- **Easy extensibility** for new features
- **Reduced maintenance burden** for operations teams

**Workflow:**
1. Develop feature → Add files to `contrib/`
2. Run `generate_ansible.py`
3. Generated playbooks include new feature
4. Deploy with `ansible-playbook`

**Result:** Infrastructure as code that's truly code-generated and always reflects your actual source code.

---

## Additional Resources

- **Ansible Documentation:** https://docs.ansible.com/
- **Generated Playbooks:** `contrib/ansible/`
- **Deployment Guide:** `contrib/DEPLOYMENT_GUIDE.md`
- **Generator Source:** `contrib/generate_ansible.py`

---

**Last Updated:** 29-Nov-2025
**Version:** 1.3.0
**Maintainer:** Dan Caescu <dan.caescu@multitel.net>
